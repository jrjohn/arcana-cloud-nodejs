# Docker Compose for testing layered architecture with HTTP and gRPC communication
# Usage:
#   gRPC mode (default): docker-compose -f docker-compose.test.layered.yml up
#   HTTP mode: PROTOCOL=http docker-compose -f docker-compose.test.layered.yml up

services:
  # Test runner - runs communication layer tests
  test-runner:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    environment:
      - NODE_ENV=testing
      - DEPLOYMENT_MODE=layered
      - DEPLOYMENT_LAYER=controller
      - COMMUNICATION_PROTOCOL=${PROTOCOL:-grpc}
      - SERVICE_URL=http://service-layer:3001
      - GRPC_SERVICE_URL=service-layer:50051
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=test-secret-key-min-32-characters-for-testing!
    depends_on:
      service-layer:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: npm run test:vitest -- --run
    networks:
      - layered-test-network

  # Controller layer (HTTP API)
  controller-layer:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=testing
      - PORT=3000
      - DEPLOYMENT_MODE=layered
      - DEPLOYMENT_LAYER=controller
      - COMMUNICATION_PROTOCOL=${PROTOCOL:-grpc}
      - SERVICE_URL=http://service-layer:3001
      - GRPC_SERVICE_URL=service-layer:50051
      - JWT_SECRET=test-secret-key-min-32-characters-for-testing!
    depends_on:
      service-layer:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    command: npm run start
    networks:
      - layered-test-network

  # Service layer (Business Logic)
  service-layer:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    ports:
      - "3001:3001"
      - "50051:50051"
    environment:
      - NODE_ENV=testing
      - PORT=3001
      - GRPC_PORT=50051
      - DEPLOYMENT_MODE=layered
      - DEPLOYMENT_LAYER=service
      - COMMUNICATION_PROTOCOL=${PROTOCOL:-grpc}
      - REPOSITORY_URL=http://repository-layer:3002
      - GRPC_REPOSITORY_URL=repository-layer:50052
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=test-secret-key-min-32-characters-for-testing!
    depends_on:
      repository-layer:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    command: npm run start
    networks:
      - layered-test-network

  # Repository layer (Data Access)
  repository-layer:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    ports:
      - "3002:3002"
      - "50052:50052"
    environment:
      - NODE_ENV=testing
      - PORT=3002
      - GRPC_PORT=50052
      - DEPLOYMENT_MODE=layered
      - DEPLOYMENT_LAYER=repository
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=test-secret-key-min-32-characters-for-testing!
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    command: npm run start
    networks:
      - layered-test-network

  # Redis for distributed systems
  redis:
    image: redis:7-alpine
    ports:
      - "6381:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - layered-test-network

networks:
  layered-test-network:
    driver: bridge
